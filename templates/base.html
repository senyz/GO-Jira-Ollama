<!DOCTYPE html>
<html lang="ru">
<head>
    {{template "static/head" .}}
</head>
<body>
    <div class="container">
        {{template "static/header" .}}
        {{template "static/stats" .}}
        {{template "static/models" .}}
        {{template "static/task_form" .}}
        {{template "static/tasks" .}}
        {{template "static/ai_form" .}}
        
        <div id="message" class="{{ if .error }}error{{ else }}hidden{{ end }}">
            <i class="fas fa-exclamation-circle"></i> {{ .error }}
        </div>
    </div>

    <script>
    let selectedModel = "{{.SelectedModel}}";

    // Инициализация при загрузке
    $(document).ready(function() {
        if (selectedModel) {
            $('#current-model').html('<i class="fas fa-check"></i> ' + selectedModel);
            $('#selected-model-count').text(1);
            $('#ai-submit').prop('disabled', false);
            
            // Устанавливаем выбранную модель в select
            $('#model-select').val(selectedModel);
        }
    });

    function selectModel(modelName) {
        if (!modelName) return;
        
        selectedModel = modelName;
        $('#current-model').html('<i class="fas fa-check"></i> ' + modelName);
        $('#selected-model-count').text(modelName ? 1 : 0);
        $('#ai-submit').prop('disabled', !modelName);
        
        // Устанавливаем выбранное значение в select
        $('#model-select').val(modelName);
        
        // Сохраняем выбор на сервере
        $.post('/select-model', { model: modelName })
            .fail(function() {
                console.error('Ошибка сохранения выбора модели');
            });
    }

function refreshModels() {
    const btn = $('button').filter(function() {
        return $(this).text().includes('Обновить модели');
    });
    
    btn.prop('disabled', true).html('<span class="loading"></span> Обновление...');
    
    $.get('/api/models')
        .done(function(data) {
            // Обновляем список моделей
            updateModelsList(data);
        })
        .fail(function(xhr) {
            $('#models-list').html('<div class="error">Ошибка загрузки моделей</div>');
        })
        .always(function() {
            btn.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Обновить модели');
        });
}

function updateModelsList(data) {
    let html = '';
    if (data && data.length > 0) {
        data.forEach(modelGroup => {
            if (modelGroup.models && modelGroup.models.length > 0) {
                modelGroup.models.forEach(model => {
                    html += `
                        <div class="model-card">
                            <h3>${model.name}</h3>
                            <div class="model-info">
                                <p><strong>Модель:</strong> ${model.model}</p>
                                <p><strong>Размер:</strong> ${model.details?.parameter_size || 'N/A'}</p>
                                <p><strong>Семейство:</strong> ${model.details?.family || 'N/A'}</p>
                            </div>
                            <button class="btn btn-secondary" onclick="selectModel('${model.name}')">
                                <i class="fas fa-check"></i> Выбрать
                            </button>
                        </div>
                    `;
                });
            }
        });
    }
    $('#models-list').html(html || '<div class="error">Модели не загружены</div>');
}

function sendToAI() {
    if (!selectedModel) {
        alert('Пожалуйста, сначала выберите модель');
        return;
    }

    const messages = $('#aiMessages').val().trim();
    const temperature = $('#temperature').val();
    
    if (!messages) {
        alert('Пожалуйста, введите сообщение');
        return;
    }

    $('#ai-response').removeClass('hidden').html('<div class="loading"></div> ИИ анализирует...');
    
    // Отправка запроса к выбранной модели
    $.post('/send-to-ai', {
        model: selectedModel,
        messages: messages,
        temperature: temperature
    })
    .done(function(response) {
        $('#ai-response').html(`
            <div class="success">
                <h4><i class="fas fa-robot"></i> Ответ от ${selectedModel}:</h4>
                <p>${response.answer || 'Нет ответа'}</p>
            </div>
        `);
    })
    .fail(function(xhr) {
        $('#ai-response').html(`
            <div class="error">
                <i class="fas fa-exclamation-triangle"></i> Ошибка: ${xhr.responseText || 'Неизвестная ошибка'}
            </div>
        `);
    });
}

</script>
</body>
</html>